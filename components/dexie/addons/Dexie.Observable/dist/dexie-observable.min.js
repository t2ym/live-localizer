!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n(require("dexie")):"function"==typeof define&&define.amd?define(["dexie"],n):(e.Dexie=e.Dexie||{},e.Dexie.Observable=n(e.Dexie))}(this,function(e){"use strict";function n(l){function u(t){n.latestRevision[l.name]<t&&(n.latestRevision[l.name]=t,e.ignoreTransaction(function(){n.on("latestRevisionIncremented").fire(l.name,t)}),T.setItem("Dexie.Observable/latestRevision/"+l.name,t))}function d(t){var i=t.name;t.hook("creating").subscribe(function(o,r,a){var s=void 0;void 0===o&&t.schema.primKey.uuid&&(o=s=n.createUUID(),t.schema.primKey.keyPath&&e.setByKeyPath(r,t.schema.primKey.keyPath,o));var c={source:a.source||null,table:i,key:void 0===o?null:o,type:O,obj:r},u=l._changes.add(c).then(function(e){return a._lastWrittenRevision=Math.max(a._lastWrittenRevision,e),e});return this.onsuccess=function(e){o!=e&&u._then(function(){c.key=e,l._changes.put(c)})},this.onerror=function(e){u._then(function(e){l._changes.delete(e)})},s}),t.hook("updating").subscribe(function(n,t,o,r){var a={},s=!1,c=e.deepClone(o);for(var u in n){var d=n[u];if("undefined"==typeof d)e.delByKeyPath(c,u),a[u]=null,s=!0;else{var f=e.getByKeyPath(o,u);d!==f&&JSON.stringify(d)!==JSON.stringify(f)&&(e.setByKeyPath(c,u,d),a[u]=d,s=!0)}}if(s){var m={source:r.source||null,table:i,key:t,type:w,mods:a,oldObj:o,obj:c},v=l._changes.add(m);this.onsuccess=function(){v._then(function(e){r._lastWrittenRevision=Math.max(r._lastWrittenRevision,e)})},this.onerror=function(e){v._then(function(e){l._changes.delete(e)})}}}),t.hook("deleting").subscribe(function(e,n,t){var o=l._changes.add({source:t.source||null,table:i,key:e,type:S,oldObj:n}).then(function(e){return t._lastWrittenRevision=Math.max(t._lastWrittenRevision,e),e});this.onerror=function(){o._then(function(e){l._changes.delete(e)})}})}function f(n,t){if(n===l.name){if(I>=t)return;I=t,e.vip(function(){m(t).catch("DatabaseClosedError",function(e){})})}}function m(e,t,i){if(!t&&m.ongoingOperation)return m.ongoingOperation;var r=!1,a=j;if(!a)return s.reject("Database closed");var u=1e3,d=l._changes.where("rev").above(a.myRevision).limit(u).toArray(function(e){if(e.length>0){var n=e[e.length-1];r=e.length===u,l.on("changes").fire(e,r),a.myRevision=n.rev}else i&&l.on("changes").fire([],!1);return l.table("_syncNodes").update(a,{lastHeartBeat:Date.now(),deleteTimeStamp:null,myRevision:a.myRevision})}).then(function(e){if(!e)throw c?new Error("Browser is shutting down"):(l.close(),console.error("Out of sync"),o.location&&o.location.reload(!0),new Error("Out of sync"));if(r||n.latestRevision[l.name]>a.myRevision)return m(n.latestRevision[l.name],(t||0)+1,r)}).finally(function(){delete m.ongoingOperation});return t||(m.ongoingOperation=d),d}function v(){B=null;var t=j.id;e.vip(function(){m(n.latestRevision[l.name]).then(y).then(b).catch("DatabaseClosedError",function(e){}).finally(function(){j&&j.id===t&&(B=setTimeout(v,N))})})}function y(){var t=j;return t?l.transaction("rw","_syncNodes","_changes","_intercomm",function(){var i=!1;l._syncNodes.where("lastHeartBeat").below(Date.now()-x).and(function(e){return"local"===e.type}).modify(function(n){n.deleteTimeStamp&&n.deleteTimeStamp<Date.now()?(delete this.value,T.removeItem("Dexie.Observable/deadnode:"+n.id+"/"+l.name),n.isMaster&&(l._syncNodes.update(t,{isMaster:1}),i=!0),l._intercomm.where("destinationNode").equals(n.id).modify(function(n){delete this.value,n.wantReply&&e.ignoreTransaction(function(){g(n)})})):n.deleteTimeStamp||(n.deleteTimeStamp=Date.now()+R)}).then(function(){return n.deleteOldChanges(l),l.on("cleanup").fire(i)})}):s.reject("Database closed")}function p(e){j&&(c=!0,j.deleteTimeStamp=1,j.lastHeartBeat=0,l._syncNodes.put(j),n.wereTheOneDying=!0,T.setItem("Dexie.Observable/deadnode:"+j.id.toString()+"/"+l.name,"dead"))}function h(t,i){t!==l.name||n.wereTheOneDying||e.vip(function(){l._syncNodes.update(i,{deleteTimeStamp:1,lastHeartBeat:0}).then(y)})}function b(){return j?l.table("_intercomm").where("destinationNode").equals(j.id).modify(function(n){delete this.value,e.ignoreTransaction(function(){g(n)})}):s.reject("Database closed")}function g(n){if("response"===n.type){var t=C[n.requestId.toString()];t&&(n.isFailure?t.reject(n.message.error):t.resolve(n.message.result),delete C[n.requestId.toString()])}else{n.resolve=function(e){l.sendMessage("response",{result:e},n.sender,{requestId:n.id})},n.reject=function(e){l.sendMessage("response",{error:e.toString()},n.sender,{isFailure:!0,requestId:n.id})};var i=n.message;delete n.message,e.extend(n,i),l.on.message.fire(n)}}function _(e){e===l.name&&b()}var x=2e4,R=2e4,N=2e3,O=1,w=2,S=3,T=n.localStorageImpl,D=e.defineClass({myRevision:Number,type:String,lastHeartBeat:Number,deleteTimeStamp:Number,url:String,isMaster:Number,syncProtocol:String,syncContext:null,syncOptions:Object,connected:!1,status:Number,appliedRemoteRevision:null,remoteBaseRevisions:[{local:Number,remote:null}],dbUploadState:{tablesToUpload:[String],currentTable:String,currentKey:null,localBaseRevision:Number}}),j=null;Object.defineProperty(l,"_localSyncNode",{get:function(){return j}});var B=null;e.fake&&(l.version(1).stores({_syncNodes:"++id,myRevision,lastHeartBeat",_changes:"++rev",_intercomm:"++id,destinationNode",_uncommittedChanges:"++id,node"}),l._syncNodes.mapToClass(D),l._changes.mapToClass(r),j=new D({myRevision:0,type:"local",lastHeartBeat:Date.now(),deleteTimeStamp:null})),l.Version.prototype._parseStoresSpec=a(l.Version.prototype._parseStoresSpec,function(e){return function(n,t){n._changes="++rev",n._syncNodes="++id,myRevision,lastHeartBeat,url,isMaster,type,status",n._intercomm="++id,destinationNode",n._uncommittedChanges="++id,node",e.call(this,n,t),Object.keys(t).forEach(function(e){var n=t[e];0===n.primKey.name.indexOf("$$")&&(n.primKey.uuid=!0,n.primKey.name=n.primKey.name.substr(2),n.primKey.keyPath=n.primKey.keyPath.substr(2))}),Object.keys(t).forEach(function(e){0!==e.indexOf("_")&&0!==e.indexOf("$")&&(t[e].observable=!0)})}}),l._tableFactory=a(l._tableFactory,function(e){return function(n,t,i){var o=e.apply(this,arguments);return o.schema.observable&&i===l._transPromiseFactory&&d(o),"_syncNodes"===o.name&&i===l._transPromiseFactory&&o.mapToClass(D),o}}),l.on.addEventType({changes:"asap",cleanup:[i,t],message:"asap"}),l._createTransaction=a(l._createTransaction,function(e){return function(n,t,i,o){if(l.dynamicallyOpened())return e.apply(this,arguments);var r=!1;"readwrite"===n&&t.some(function(e){return i[e]&&i[e].observable})&&(r=!0,t=t.slice(0),t.indexOf("_changes")===-1&&t.push("_changes"));var a=e.call(this,n,t,i,o);return r&&(a._lastWrittenRevision=0,a.on("complete",function(){if(a._lastWrittenRevision)if(o){var e=function e(n){return n.parent?e(n.parent):n}(o);e._lastWrittenRevision=Math.max(a._lastWrittenRevision,e.lastWrittenRevision||0)}else u.timeoutHandle&&clearTimeout(u.timeoutHandle),u.timeoutHandle=setTimeout(function(){delete u.timeoutHandle,u(a._lastWrittenRevision)},25)}),a.parent&&a.parent.source&&(a.source=a.parent.source)),a}}),n.latestRevision[l.name]=n.latestRevision[l.name]||0,l.close=a(l.close,function(e){return function(){return l.dynamicallyOpened()?e.apply(this,arguments):(u.timeoutHandle&&(clearTimeout(u.timeoutHandle),delete u.timeoutHandle),n.on("latestRevisionIncremented").unsubscribe(f),n.on("suicideNurseCall").unsubscribe(h),n.on("intercomm").unsubscribe(_),n.on("beforeunload").unsubscribe(p),j&&j.id&&(n.on.suicideNurseCall.fire(l.name,j.id),T.setItem("Dexie.Observable/deadnode:"+j.id.toString()+"/"+l.name,"dead"),j.deleteTimeStamp=1,j.lastHeartBeat=0,l._syncNodes.put(j),j=null),B&&clearTimeout(B),B=null,e.apply(this,arguments))}}),l.delete=a(l.delete,function(e){return function(){return e.apply(this,arguments).then(function(e){return n.latestRevision[l.name]=0,e})}}),l.on("ready",function(){return l.dynamicallyOpened()?l:l.table("_changes").orderBy("rev").last(function(t){var i=t?t.rev:0;return j=new D({myRevision:i,type:"local",lastHeartBeat:Date.now(),deleteTimeStamp:null,isMaster:0}),n.latestRevision[l.name]<i&&(n.latestRevision[l.name]=i,e.ignoreTransaction(function(){n.on.latestRevisionIncremented.fire(i)})),l.transaction("rw","_syncNodes",function(){l._syncNodes.where("isMaster").equals(1).count(function(e){e||(j.isMaster=1),l._syncNodes.add(j).then(function(){n.on("latestRevisionIncremented",f),n.on("beforeunload",p),n.on("suicideNurseCall",h),n.on("intercomm",_),B=setTimeout(v,N)})})}).then(function(){y()})})},!0);var I=0,C={};l.sendMessage=function(t,i,o,r){if(!j)return s.reject("Database closed");r=r||{};var a={message:i,destinationNode:o,sender:j.id,type:t};e.extend(a,r);var c=["_intercomm"];return r.wantReply&&c.push("_syncNodes"),l.transaction("rw?",c,function(){function t(t){return l._intercomm.add(t).then(function(t){if(T.setItem("Dexie.Observable/intercomm/"+l.name,t.toString()),e.ignoreTransaction(function(){n.on.intercomm.fire(l.name)}),r.wantReply)return new s(function(e,n){C[t.toString()]={resolve:e,reject:n}})})}return r.wantReply?l._syncNodes.where("id").equals(o).count(function(e){return e?t(a):l._syncNodes.where("isMaster").above(0).first(function(e){return a.destinationNode=e.id,t(a)})}):void t(a)})},l.broadcastMessage=function(e,n,t){if(!j)return s.reject("Database closed");var i=j.id;l._syncNodes.each(function(o){"local"!==o.type||!t&&o.id===i||l.sendMessage(e,n,o.id)})},l.observable={},l.observable.SyncNode=D}function t(){}function i(e,n){return e===t?n:function(){var t=e.apply(this,arguments);if(t&&"function"==typeof t.then){var i=this,o=arguments;return t.then(function(){return n.apply(i,o)})}return n.apply(this,arguments)}}e="default"in e?e.default:e;var o=self,r=e.defineClass({rev:Number,source:String,table:String,key:Object,type:Number,obj:Object,mods:Object,oldObj:Object}),a=e.override,s=e.Promise,c=!1;return n.latestRevision={},n.on=e.Events(null,"latestRevisionIncremented","suicideNurseCall","intercomm","beforeunload"),n.createUUID=function(){var e=Date.now(),n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var t=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===n?t:7&t|8).toString(16)});return n},n.deleteOldChanges=function(e){e._syncNodes.orderBy("myRevision").first(function(t){var i=Date.now()+300,o=!1;e._changes.where("rev").below(t.myRevision).until(function(){return o=Date.now()>i}).delete().then(function(){o&&setTimeout(function(){n.deleteOldChanges(e)},10)})})},n._onStorage=function(t){if(0===t.key.indexOf("Dexie.Observable/")){var i=t.key.split("/"),o=i[1],r=i[2];if("latestRevision"===o){var a=parseInt(t.newValue,10);!isNaN(a)&&a>n.latestRevision[r]&&(n.latestRevision[r]=a,e.ignoreTransaction(function(){n.on("latestRevisionIncremented").fire(r,a)}))}else if(0===o.indexOf("deadnode:")){var s=parseInt(o.split(":")[1],10);t.newValue&&n.on.suicideNurseCall.fire(r,s)}else"intercomm"===o&&t.newValue&&n.on.intercomm.fire(r)}},n._onBeforeUnload=function(){n.on.beforeunload.fire()},n.localStorageImpl=o.localStorage,o.addEventListener&&(o.addEventListener("storage",n._onStorage),o.addEventListener("beforeunload",n._onBeforeUnload)),e.Observable=n,e.addons.push(n),n});
//# sourceMappingURL=dexie-observable.min.js.map